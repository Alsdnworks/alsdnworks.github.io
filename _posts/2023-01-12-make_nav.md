---
title: "í‘œì¤€ë…¸ë“œë§í¬ì™€ PostgreSQLì„ í™œìš©í•œ ê¸¸ ì°¾ê¸° ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±"
categories:
  - PostgreSQL
  - GIS
tags:
  - analyze
  - project
  
toc: true 
---

# ğŸ‘¨â€ğŸ’»í‘œì¤€ë…¸ë“œë§í¬ì™€ PostgreSQLì„ í™œìš©í•œ ê¸¸ ì°¾ê¸° ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

## 0. ìš©ì–´ ì •ë¦¬

### 0.1. ğŸ“Œí‘œì¤€ë…¸ë“œë§í¬

í‘œì¤€ë…¸ë“œë§í¬ëŠ” êµí†µì •ë³´ êµí™˜ì„ ìœ„í•œ êµí†µì •ë³´ ë„¤íŠ¸ì›Œí¬ì˜ êµ­ê°€í‘œì¤€ë‹¨ìœ„, êµí†µì •ë³´ ì‹¤ì‹œê°„ êµí™˜ì— ê¸°ë³¸ì´ ë˜ëŠ” ì „êµ­ë‹¨ìœ„ í‘œì¤€ ë…¸ë“œ/ë§í¬ë¥¼ í†µí•´ ITS í˜¸í™˜ì„±ê³¼ ìƒí˜¸ì—°ê³„ ìš´ìš© íš¨ìœ¨ì„±ì„ í™•ë³´í•˜ê³ , ëŒ€êµ­ë¯¼ êµí†µì •ë³´ ì œê³µ í¸ì˜ì¦ì§„ì„ ìœ„í•´ êµ­í†  êµí†µë¶€ì—ì„œ ì œê³µí•˜ëŠ” ì§€ë¦¬ì •ë³´ë°ì´í„°ì…‹ì´ë‹¤.

#### 0.1.1. í‘œì¤€ë…¸ë“œ

ë…¸ë“œì •ë³´ëŠ” ê·¸ë˜í”„ë°ì´í„°ì˜ í¬ì¸íŠ¸, ë²„í…ìŠ¤ì— í•´ë‹¹ë˜ëŠ” ì •ë³´ë¡œì„œ ìœ„ì¹˜ì— ëŒ€í•œ ê°œë…ìœ¼ë¡œ ë§í¬ë¥¼ í†µí•´ ì—°ê²°í•  ê°ì²´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.

#### 0.1.2. í‘œì¤€ë§í¬

ë§í¬ì •ë³´ëŠ” ê·¸ë˜í”„ë°ì´í„°ì˜ ë¼ì¸,ì—ì§€ì— í•´ë‹¹ë˜ëŠ” ì •ë³´ë¡œì„œ ë…¸ë“œê°„ì˜ ì—°ê²°ê´€ê³„ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.

### 0.2. ğŸ“ŒPostgreSQL

PostgreSQLì€ ê°ì²´-ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ì‹œìŠ¤í…œ(ORDBMS)ì˜ í•˜ë‚˜ë¡œ, ê°ì²´-ê´€ê³„í˜• ë°ì´í„° ëª¨ë¸ì„ ì‚¬ìš©í•œë‹¤. íŠ¹íˆ, ê°ì²´-ê´€ê³„í˜• ë°ì´í„° ëª¨ë¸ì€ ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì˜ ê°ì²´ ê°œë…ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì ìš©í•œ ê²ƒì´ë‹¤. PostgreSQLì€ ê°ì²´-ê´€ê³„í˜• ë°ì´í„° ëª¨ë¸ì„ ì‚¬ìš©í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ì‹œìŠ¤í…œ ì¤‘ ê°€ì¥ ë„ë¦¬ ì‚¬ìš©ë˜ê³  ìˆë‹¤.

#### 0.2.1. Postgis

PostGISëŠ” PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ì— GIS ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ í™•ì¥ ëª¨ë“ˆì´ë‹¤. PostGISëŠ” ê³µê°„ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³ , ê²€ìƒ‰í•˜ê³ , ì¡°ì‘í•˜ê³ , ë¶„ì„í•˜ëŠ”ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

#### 0.2.2. pgRouting

pgRoutingì€ PostGIS / PostgreSQL ì§€ë¦¬ ê³µê°„ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í™•ì¥í•˜ì—¬ ì§€ë¦¬ ê³µê°„ ë¼ìš°íŒ… ë° ê¸°íƒ€ ë„¤íŠ¸ì›Œí¬ ë¶„ì„ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

## 1. ê°œë°œí™˜ê²½ ì¤€ë¹„

ê°œë°œí™˜ê²½êµ¬ì¶•ì„ ìœ„í•´ ì‚¬ìš©í•œ í¬ìŠ¤íŠ¸ì˜ ë§í¬ë¥¼ ì°¸ê³ í•´ Postgresqlê³¼ Postgisë¥¼ ì„¤ì¹˜í•œë‹¤.

> https://projooni.tistory.com/entry/GIS-%EA%B0%9C%EB%B0%9C%ED%99%98%EA%B2%BD-%EC%84%B8%ED%8C%85-3-PostgreSQL-PostGIS-%EC%84%A4%EC%B9%98

## 2. ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±

### 2.1. í‘œì¤€ ë…¸ë“œë§í¬ ë‹¤ìš´ë¡œë“œ

ë‹¤ìŒ ë§í¬ë¥¼ í†µí•´ í‘œì¤€ë…¸ë“œë§í¬ ë°ì´í„°ì…‹ì„ ë‹¤ìš´ë¡œë“œ ë°›ëŠ”ë‹¤.
> https://www.its.go.kr/nodelink/nodelinkRef

### 2.2. ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±

ìœ„ì˜ í¬ìŠ¤íŠ¸ë¥¼ ë”°ë¼ PostgreSQLì„ ì„¤ì¹˜í•˜ë©´ ê°™ì´ ì„¤ì¹˜ë˜ëŠ” pgAdminì„ í†µí•´ DBë¥¼ í™•ì¸í•´ë³´ë©´ ê¸°ë³¸ìœ¼ë¡œ ìƒì„±ëœ postgres db ì™¸ì— postgisë¡œ ì‹œì‘í•˜ëŠ” ì´ë¦„ì˜ dbê°€ ìƒì„±ëœë‹¤. (ìœ„ í¬ìŠ¤íŠ¸ì—ì„œëŠ” postgisë¡œ ìƒì„±ë˜ì—ˆì§€ë§Œ í•„ìëŠ” postgis_33_sampleë¡œ ìƒì„±ë¨) ì´ dbë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ìƒˆë¡œìš´ dbë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•œë‹¤.

### 2.3. í‘œì¤€ë…¸ë“œë§í¬ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì ì¬

ìœ„ì˜ í¬ìŠ¤íŠ¸ë¥¼ ë”°ë¼ ì„¤ì¹˜í•œ 'PostGIS PostGIS Bundle 3 for PostgreSQL x64 14 Shapefile and DBF Loader Exporter' ë¥¼ ì‹¤í–‰í•œë‹¤. <br>ê¸°ë³¸ì ì¸ ì„¤ì¹˜ ê²½ë¡œë¡œ ì„¤ì¹˜í–ˆë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ê²½ë¡œì— ì„¤ì¹˜ëœë‹¤.
> C:\Program Files\PostgreSQL\14\bin\postgisgui\shp2pgsql-gui.exe

ì„¤ì¹˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ê³  ë‹¤ìŒê³¼ ê°™ì´ ì‹¤í–‰í•œë‹¤.
<br>

![](/assets/img/make_nav/1.png)

|Connectionì„ ìœ„í•œ ì°¸ê³ ìë£Œ||
|:---:|:---:|
| Username | postgres(ì°¸ê³  í¬ìŠ¤íŠ¸ë¥¼ ë”°ë¼ ì„¤ì¹˜í–ˆë‹¤ë©´ ê¸°ë³¸ê°’) |
| Password | ì„¤ì¹˜ì‹œ ë“±ë¡í•œ ë¹„ë°€ë²ˆí˜¸ |
| Server Host | localhost 5432(ì°¸ê³  í¬ìŠ¤íŠ¸ë¥¼ ë”°ë¼ ì„¤ì¹˜í–ˆë‹¤ë©´ ê¸°ë³¸ê°’) |
| Database | 2ë²ˆì—ì„œ ìƒì„±í•œ db ì´ë¦„ |

1. 'Add File'ì„ ì‚¬ìš©í•´ 1ì—ì„œ ë‹¤ìš´ë¡œë“œ ë°›ì€ í‘œì¤€ë…¸ë“œë§í¬ shp íŒŒì¼ 2ê°œë¥¼ ì¶”ê°€í•œë‹¤.
2. í‘œì¤€ë…¸ë“œë§í¬ì˜ ì¢Œí‘œê³„ëŠ” êµ­í† ì§€ë¦¬ì›í‘œì¤€ EPSG5186ì„ ë”°ë¥´ë¯€ë¡œ SRIDë¥¼ 5186ìœ¼ë¡œ ì„¤ì •í•œë‹¤.
3. Tableì˜ ì´ë¦„ì€ íŒŒì¼ëª…ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•œë‹¤.(moct_link, moct_node) 
4. importë²„íŠ¼ì„ ëˆŒëŸ¬ DBì— ë¡œë“œí•œë‹¤.

## 3. SQLì‘ì„±

### 3.1. í™•ì¥ê¸°ëŠ¥ ì„¤ì¹˜, í…Œì´ë¸” ê²€í† 

~~~sql
--í™•ì¥ê¸°ëŠ¥ì´ ì„¤ì¹˜ë˜ì–´ìˆëŠ”ì§€ í™•ì¸
CREATE EXTENSION postgis;
CREATE EXTENSION pgrouting;
--í…Œì´ë¸”ì´ ì˜ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
select * from moct_link;
select * from moct_node;
~~~

### 3.2. ì¸ë±ìŠ¤ ìƒì„±

~~~sql
--linkì˜ ê²½ìš° select column_name from information_schema.columns  where TABLE_NAME = 'moct_link'ë¥¼ í†µí•´ ì»¬ëŸ¼ëª… í™•ì¸í›„ ì§„í–‰ ì´ë•Œ ì˜¤ë¥˜ë°œìƒì‹œ ê±´ë„ˆë›°ê¸°(geomì¹¼ëŸ¼ê³¼ ê°™ì´ ë°ì´í„°ê°€ í° ê²½ìš° ë°œìƒ)
--nodeì˜ ê²½ìš° select column_name from information_schema.columns  where TABLE_NAME = 'moct_node' ë¥¼ í†µí•´ ì»¬ëŸ¼ëª… í™•ì¸

create index moctlink_gid_idx on public.moct_link(gid);
create index moctlink_lanes_idx on public.moct_link(lanes);
create index moctlink_max_spd_idx on public.moct_link(max_spd);
create index moctlink_rest_w_idx on public.moct_link(rest_w);
create index moctlink_rest_h_idx on public.moct_link(rest_h);
create index moctlink_length_idx on public.moct_link(length);
create index moctlink_road_no_idx on public.moct_link(road_no);
create index moctlink_road_name_idx on public.moct_link(road_name);
create index moctlink_road_use_idx on public.moct_link(road_use);
create index moctlink_multi_link_idx on public.moct_link(multi_lin)k;
create index moctlink_connect_idx on public.moct_link(connect);
create index moctlink_remark_idx on public.moct_link(remark);
create index moctlink_link_id_idx on public.moct_link(link_id);
create index moctlink_f_node_idx on public.moct_link(f_node);
create index moctlink_t_node_idx on public.moct_link(t_node);
create index moctlink_rest_veh_idx on public.moct_link(rest_veh);
create index moctlink_road_rank_idx on public.moct_link(road_rank);
create index moctlink_road_type_idx on public.moct_link(road_type);

create index moctnode_gid_idx on public.moct_node(gid);
create index moctnode_geom_idx on public.moct_node(geom);
create index moctnode_node_type_idx on public.moct_node(node_type);
create index moctnode_turn_p_idx on public.moct_node(turn_p);
create index moctnode_remark_idx on public.moct_node(remark);
create index moctnode_node_name_idx on public.moct_node(node_name);
create index moctnode_node_id_idx on public.moct_node(node_id);
~~~

### 3.3. ìµœê³ ì†ë„ë¡œ linkì˜ ê²½ë¡œë¥¼ í†µê³¼í• ë•Œì˜ ìµœì†Œì‹œê°„ ì‚°ì •

~~~sql
--min_costì‚°ì • ë° ì¸ë±ìŠ¤ ìƒì„±
ALTER TABLE moct_link ADD COLUMN min_cost real;
UPDATE moct_link SET min_cost=(length/(max_spd::real/36)/10); 
create index moctlink_min_cost_idx on public.moct_link(min_cost);
~~~

### 3.4. ë„ë¡œëª… ê¸°ì¤€ìœ¼ë¡œ geomê³¼ idê²€ìƒ‰

~~~sql
--ê²€ìƒ‰
select l.f_node,l.geom from moct_link as l where l.road_name like 'ê°•ì›ëŒ€%';

--ê²€ìƒ‰ëœ ê²°ê³¼ì˜ gomìƒ nodeë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ì„¸ì…˜ ë³€ìˆ˜ ì§€ì •
set session  my.vars.START_POINT =  2250008800;
set session  my.vars.END_POINT= 2500012800;
~~~

### 3.5. dijkstra ìµœë‹¨ê²½ë¡œ ì•Œê³ ë¦¬ì¦˜ì„ í†µí•œ ê²½ë¡œ íƒìƒ‰ ê²°ê³¼ë¥¼ dijkstra_resultí…Œì´ë¸”ì— ì €ì¥

~~~sql
--dijkstraìˆ˜í–‰
drop table if exists dijkstra_result;
create table dijkstra_result as
select l.road_name, l.max_spd, l.length, l.min_cost, l.geom, d.path_seq, d.agg_cost
FROM moct_link AS l 
inner join (
	select edge::varchar(10) , seq, path_seq , node , cost, agg_cost
	FROM pgr_dijkstra(
		'SELECT link_id::bigint as id, 
			f_node::bigint as source, 
			t_node::bigint as target, 
			length::bigint as cost
		FROM moct_link'
		,current_setting('my.vars.START_POINT')::bigint, current_setting('my.vars.END_POINT')::bigint
	)
) as d
on l.link_id=d.edge;
~~~

### 3.6. ì‚°ì •ëœ í…Œì´ë¸”ì„ í†µí•œ ê²½ë¡œ ì„¸ë¶€ì •ë³´ ì¶œë ¥

~~~sql
--ì£¼í–‰í…Œì´ë¸”
select * from dijkstra_result dr  order by path_seq asc;

--ì—°ì¥
select max(agg_cost)/1000 as "cost(km)" from dijkstra_result;

--ìµœì†Œ í†µê³¼ ì‹œê°„: lenì„ max_speedë¡œ ì£¼í–‰í•´ í†µê³¼í•˜ëŠ” ì‹œê°„
select sum(min_cost)/60 as "cost(minute)" from dijkstra_result;
~~~

## 4. í™œìš©ì˜ˆì‹œ

-ë‹¤ìŒê³¼ ê°™ì´ ì¤€ë¹„ëœ ì¿¼ë¦¬ë¥¼ ê°€ì§€ê³  Djangoë¥¼ í™œìš©í•´ ê¸°ì´ˆì ì¸ ê¸¸ì°¾ê¸° ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬í˜„í•˜ì˜€ë‹¤.
-êµí†µëŸ‰ì •ë³´ê°€ ë°˜ì˜ë˜ì§€ì•Šê¸°ì— ë„¤ì´ë²„ì§€ë„ì™€ ë¹„êµí–ˆì„ë•ŒëŠ” 6ë¶„ì •ë„ì˜ ì°¨ì´ê°€ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤.

![](/assets/img/make_nav/2.png)